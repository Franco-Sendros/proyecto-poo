<!DOCTYPE html>
<!-- Configuro el lenguaje al español -->
<html lang="es">
<head>
    <!-- Meta para soportar todos los caracteres en la mayoría de los lenguajes del mundo -->
    <meta charset="UTF-8">
    <!-- Define el título de la página web -->
    <title>Gestión de Usuario</title>
    <!-- Enlaza HTML y CSS -->
    <link rel="stylesheet" href="/css/style.css">
    <style>
        /* Estilo adicional para colocar los botones en línea */
        .button-container {
            display: flex;
            justify-content: space-between;
        }
        .button-container button {
            width: 48%;
        }
    </style>
</head>
<body>
<section>
    <!-- Div para dividir el contenido -->
    <div class="contenedor">
        <!-- Div para darle características al formulario -->
        <div class="formulario">
            <!-- Formulario HTML para enviar datos -->
            <form id="userForm">
                <!-- Subtitulo del formulario -->
                <h2>Gestión de Usuario</h2>
                <!-- Contenedor del input para el nombre de usuario -->
                <div class="input-contenedor">
                    <input type="text" id="username" name="username" required>
                    <label for="username">Nombre de usuario</label>
                </div>
                <!-- Contenedor del input para la contraseña -->
                <div class="input-contenedor">
                    <input type="password" id="password" name="password">
                    <label for="password">Contraseña</label>
                </div>
                <!-- Contenedor del select para el rol -->
                <div class="input-contenedor">
                    <select id="role" name="role" required>
                        <option value="" disabled selected></option>
                        <option value="ADMIN">ADMIN</option>
                        <option value="PROFESSOR">PROFESOR</option>
                        <option value="STUDENT">ESTUDIANTE</option>
                    </select>
                    <label for="role">Rol</label>
                </div>
                <!-- Contenedor para los botones -->
                <div class="button-container">
                    <button type="submit">Actualizar</button>
                    <button type="button" id="deleteButton">Eliminar</button>
                </div>
            </form>
            <!-- Enlace para volver a la página anterior -->
            <div class="registrar">
                <p><a href="sistema_login/gestion">Volver</a></p>
            </div>
        </div>
    </div>
</section>

<!-- Agregar el script aquí para manejar la obtención, actualización y eliminación del usuario -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const userId = window.location.pathname.split('/').pop();
        // Obtener datos del usuario
        fetch(`/sistema_abm/users/${userId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al obtener los datos del usuario');
                }
                return response.json();
            })
            .then(data => {
                if (data) {
                    document.getElementById('username').value = data.username || '';
                    document.getElementById('role').value = data.role || '';
                }
            })
            .catch(error => {
                console.error('Error al obtener los datos del usuario:', error);
            });

        // Manejar la actualización del usuario
        document.getElementById('userForm').addEventListener('submit', function(event) {
            event.preventDefault();

            const formData = new FormData(this);
            const data = {};
            formData.forEach((value, key) => {
                data[key] = value;
            });

            fetch(`/sistema_abm/users/${userId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('Error al actualizar el usuario');
                    }
                })
                .then(data => {
                    console.log('Actualización exitosa:', data);
                    window.location.href = '/sistema_login/gestion';
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        });

        // Manejar la eliminación del usuario
        document.getElementById('deleteButton').addEventListener('click', function() {
            if (confirm('¿Estás seguro de que deseas eliminar este usuario?')) {
                fetch(`/sistema_abm/users/${userId}`, {
                    method: 'DELETE'
                })
                    .then(response => {
                        if (response.ok) {
                            window.location.href = '/sistema_login/gestion';
                        } else {
                            throw new Error('Error al eliminar el usuario');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            }
        });
    });
</script>
</body>
</html>